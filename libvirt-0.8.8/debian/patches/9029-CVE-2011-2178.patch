From b598ac555c8fe67ffc39ac8ef25fe7e6b28ae3f2 Mon Sep 17 00:00:00 2001
From: Eric Blake <eblake@redhat.com>
Date: Thu, 26 May 2011 08:18:46 -0600
Subject: [PATCH] security: plug regression introduced in disk probe logic

Regression introduced in commit d6623003 (v0.8.8) - using the
wrong sizeof operand meant that security manager private data
was overlaying the allowDiskFormatProbing member of struct
_virSecurityManager.  This reopens disk probing, which was
supposed to be prevented by the solution to CVE-2010-2238.

* src/security/security_manager.c
(virSecurityManagerGetPrivateData): Use correct offset.
---
 src/security/security_manager.c |    4 +++-
 1 files changed, 3 insertions(+), 1 deletions(-)

Index: libvirt-0.8.8/src/security/security_manager.c
===================================================================
--- libvirt-0.8.8.orig/src/security/security_manager.c	2011-06-10 16:49:39.000000000 -0500
+++ libvirt-0.8.8/src/security/security_manager.c	2011-06-10 16:50:59.000000000 -0500
@@ -107,7 +107,9 @@
 
 void *virSecurityManagerGetPrivateData(virSecurityManagerPtr mgr)
 {
-    return ((char*)mgr) + sizeof(mgr);
+    /* This accesses the memory just beyond mgr, which was allocated
+     * via VIR_ALLOC_VAR earlier.  */
+    return mgr + 1;
 }
 
 
